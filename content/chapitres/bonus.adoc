= Bonus


== Les petits plus

image::902050214-image2.png[]
image::902050214-image2.png[]
image::902050214-image2.png[]
image::902050214-image2.png[]
image::902050214-image2.png[]
image::902050214-image2.png[]

[%auto-animate]
== "Il en remet une couche"

[source,bash]
----
docker history nginx
IMAGE               CREATED             CREATED BY                                      SIZE                COMMENT
f35646e83998        4 weeks ago         /bin/sh -c #(nop)  CMD ["nginx" "-g" "daemon‚Ä¶   0B
<missing>           4 weeks ago         /bin/sh -c #(nop)  STOPSIGNAL SIGTERM           0B
<missing>           4 weeks ago         /bin/sh -c #(nop)  EXPOSE 80                    0B
<missing>           4 weeks ago         /bin/sh -c #(nop)  ENTRYPOINT ["/docker-entr‚Ä¶   0B
<missing>           4 weeks ago         /bin/sh -c #(nop) COPY file:0fd5fca330dcd6a7‚Ä¶   1.04kB
<missing>           4 weeks ago         /bin/sh -c #(nop) COPY file:1d0a4127e78a26c1‚Ä¶   1.96kB
<missing>           4 weeks ago         /bin/sh -c #(nop) COPY file:e7e183879c35719c‚Ä¶   1.2kB
<missing>           4 weeks ago         /bin/sh -c set -x     && addgroup --system -‚Ä¶   63.6MB
<missing>           4 weeks ago         /bin/sh -c #(nop)  ENV PKG_RELEASE=1~buster     0B
<missing>           4 weeks ago         /bin/sh -c #(nop)  ENV NJS_VERSION=0.4.4        0B
<missing>           4 weeks ago         /bin/sh -c #(nop)  ENV NGINX_VERSION=1.19.3     0B
<missing>           4 weeks ago         /bin/sh -c #(nop)  LABEL maintainer=NGINX Do‚Ä¶   0B
<missing>           4 weeks ago         /bin/sh -c #(nop)  CMD ["bash"]                 0B
<missing>           4 weeks ago         /bin/sh -c #(nop) ADD file:0dc53e7886c35bc21‚Ä¶   69.2MB
----

[%auto-animate]
== "Il en remet une couche"

[source,bash]
----
docker history nginx
IMAGE               CREATED             CREATED BY                                      SIZE                COMMENT
f35646e83998        4 weeks ago         /bin/sh -c #(nop)  CMD ["nginx" "-g" "daemon‚Ä¶   0B
<missing>           4 weeks ago         /bin/sh -c #(nop)  STOPSIGNAL SIGTERM           0B
<missing>           4 weeks ago         /bin/sh -c #(nop)  EXPOSE 80                    0B
<missing>           4 weeks ago         /bin/sh -c #(nop)  ENTRYPOINT ["/docker-entr‚Ä¶   0B
<missing>           4 weeks ago         /bin/sh -c #(nop) COPY file:0fd5fca330dcd6a7‚Ä¶   1.04kB
<missing>           4 weeks ago         /bin/sh -c #(nop) COPY file:1d0a4127e78a26c1‚Ä¶   1.96kB
<missing>           4 weeks ago         /bin/sh -c #(nop) COPY file:e7e183879c35719c‚Ä¶   1.2kB
<missing>           4 weeks ago         /bin/sh -c set -x     && addgroup --system -‚Ä¶   63.6MB
<missing>           4 weeks ago         /bin/sh -c #(nop)  ENV PKG_RELEASE=1~buster     0B
<missing>           4 weeks ago         /bin/sh -c #(nop)  ENV NJS_VERSION=0.4.4        0B
<missing>           4 weeks ago         /bin/sh -c #(nop)  ENV NGINX_VERSION=1.19.3     0B
<missing>           4 weeks ago         /bin/sh -c #(nop)  LABEL maintainer=NGINX Do‚Ä¶   0B
<missing>           4 weeks ago         /bin/sh -c #(nop)  CMD ["bash"]                 0B
<missing>           4 weeks ago         /bin/sh -c #(nop) ADD file:0dc53e7886c35bc21‚Ä¶   69.2MB
----

Il est pr√©f√©rable de limiter le nombre de couches pour limiter la bande passante.

[%auto-animate]
== "Il en remet une couche"

[source,bash]
----
RUN apk add \
     patch \
     tar \
     mercurial \
     git \
     ruby \
     ruby-devel \
     rubygem-bundler \
     make \
     gcc-c++ \
     zlib-devel \
     libxml2-devel \
     docker \
     nodejs \
     npm \
     sssd \
 && mkdir -p /var/lib/docker-builder \
 && mkdir -p /etc/docker-builder
----

== Ne pas charger inutilement !

[source,bash]
----
 && apk remove make gcc maven ... \
 && rm -f previously-downloaded.tar.gz \
 && apk clean all \
 && rm -rf /tmp/*
----
[%step]
Il est utile, pour des raisons d'espace, de nettoyer le filesystem de ses futurs containers, en donnant les bonnes instructions dans le Dockerfile.

== Documentez !

Les mots cl√©s `EXPOSE` et `LABEL` peuvent fournir de pr√©cieuses informations aux utilisateurs de vos images !

(les ports expos√©s par d√©faut, les auteurs de l'image, la version d'un middleware embarqu√©, ‚Ä¶)

== Pr√©parez-vous au read-only

Il est possible de lister toutes les modifications qui ont √©t√© apport√©es au filesystem d'un container.

[source,bash]
----
docker diff 29f1c4
C /run
A /run/nginx.pid
C /var
C /var/lib
C /var/lib/nginx
C /var/lib/nginx/tmp
A /var/lib/nginx/tmp/client_body
A /var/lib/nginx/tmp/fastcgi
A /var/lib/nginx/tmp/proxy
A /var/lib/nginx/tmp/scgi
A /var/lib/nginx/tmp/uwsgi
C /var/log
C /var/log/nginx
A /var/log/nginx/access.log
A /var/log/nginx/error.log
----
[%step]
Une bonne piste pour savoir quels volumes d√©clarer !

== HealthCheck

Savoir que mon PID 1 est toujours en cours d'ex√©cution n'est peut-√™tre pas la meilleure piste pour savoir si mon conteneur est en bonne sant√© !

[source,bash]
----
FROM ghost:3
RUN apt update && apt install curl -y \
        && rm -rf /var/lib/apt/lists/*

HEALTHCHECK --interval=1m --timeout=30s --retries=3 CMD curl --fail http://localhost:2368 || exit 1
----

source : https://www.grottedubarbu.fr/docker-healthcheck/

== Debugging

image::1939424428-image3.gif[]

== Une tonne d'outils !

Les logs

* des containers

* du d√©mon Docker

[source,bash]
----
docker container exec
docker inspect
docker cp
docker history
docker stats
----

== Debugging : Les logs

rappel : `docker container logs` permet de lister les logs des conteneurs.

[%step]
[source,bash]
----
docker container logs 47d6
Fri Nov 20 00:39:52 UTC 2023
Fri Nov 20 00:39:53 UTC 2023
----

== Concentrateur de logs

Par d√©faut, les logs des conteneurs sont stock√©s dans des fichiers json. Mais comment faire pour les envoyer vers un concentrateur ?

[%step]
----
docker container run -d
--log-driver=gelf
--log-opt gelf-address=udp://localhost:12201
-p 88:80
nginx
----
[%step]
on sp√©cifie un driver
[%step]
on configure le driver

== Travaux pratiques #13

√âtapes

Lancer une stack ELK gr√¢ce aux fichiers fournis dans le repo https://gitlab.univ-artois.fr/bruno.verachten/devops-docker-tp13

Alimenter en logs avec la commande `docker run --log-driver=gelf --log-opt gelf-address=udp://localhost:12201 alpine bash -c 'seq 1 100'`

Cr√©er un index "timestamp" sur Kibana puis aller √† l'√©cran "discover"

Lancer un conteneur nginx et concentrez ses logs dans ELK

[.columns]
== GitLab et Dependabot

[.column]
image::https://about.gitlab.com/images/press/press-kit-icon.svg[height=200px]
[.column]
image::https://avatars.githubusercontent.com/u/27347476?s=200&v=4[height=200px]

== ü§î Qu'est-ce que Dependabot ?

Dependabot est un outil qui vous aide √† maintenir vos d√©pendances √† jour.

image::https://avatars.githubusercontent.com/u/27347476?s=200&v=4[]

[%step]
Il ouvre automatiquement des merge requests pour les mises √† jour de d√©pendances dans vos projets GitLab.

== üõ†Ô∏è Comment Dependabot fonctionne-t-il avec Docker ?

Dependabot peut analyser vos `Dockerfiles` et vos fichiers `docker-compose` pour trouver les d√©pendances qui peuvent √™tre mises √† jour.
[%step]
Il cr√©e ensuite des merge requests pour chaque mise √† jour de d√©pendance.

== üéØ Pourquoi utiliser Dependabot avec Docker ?

. Garder vos d√©pendances √† jour est crucial pour la s√©curit√© et la stabilit√© de vos applications.
. Dependabot automatise ce processus, vous faisant gagner du temps et r√©duisant le risque d'oublier une mise √† jour importante.
. Dependabot n'est pas magique, il faut que votre CI soit capable de construire votre application avec les nouvelles d√©pendances.
. Ce qui n'est pas test√© ne fonctionne pas.

[%auto-animate]
== üöÄ Comment configurer Dependabot pour GitLab ? ü¶äüõ†Ô∏è

* Malheureusement, il n'y a pas encore de support officiel pour GitLab dans Dependabot (et vice versa).
[%step]
* Notre forge Gitlab est d√©finie dans un fichier docker-compose.yml, et Dependabot aussi.
* Dependabot doit avoir acc√®s √† notre forge GitLab pour pouvoir ouvrir des merge requests.
* Suivons donc https://dependabot-gitlab.gitlab.io/dependabot/guide/getting-started.html#step-2-set-up-access-tokens[la documentation officielle].

[%auto-animate]
== !

image::personal-access-token.png[background, size=cover]

[%auto-animate]
== !

image::personal-access-token-settings.png[background, size=cover]

[%auto-animate]
== üöÄ Comment configurer Dependabot pour GitLab ? ü¶äüõ†Ô∏è

WARNING: Notez bien le token, vous ne le reverrez plus jamais.

https://dependabot-gitlab.gitlab.io/dependabot/guide/getting-started.html#step-3-start-the-app[L'√©tape suivante], c'est de positionner les valeurs de certaines variables d'environnement.
√áa peut √™tre dans un `.env`, ou dans les variables d'environnement de votre machine.
[source,bash]
----
export SETTINGS__GITLAB_URL=http://localhost
export SETTINGS__GITLAB_ACCESS_TOKEN=glpat-LXUfrxeFXuRJXNTNNifD
----

[%auto-animate]
== üöÄ Comment configurer Dependabot pour GitLab ? ü¶äüõ†Ô∏è

D√©marrez l'application avec `docker compose`:

[source,bash]
----
curl -s https://gitlab.com/dependabot-gitlab/dependabot/-/raw/v3.8.0-alpha.1/docker-compose.yml | docker compose -f - up -d
----
[%step]
image::dependabot-cant-see-gitlab.png[]
[%step]
üò¢

[%auto-animate]
== üöÄ Comment configurer Dependabot pour GitLab ? ü¶äüõ†Ô∏è

Vous vous souvenez du chapitre sur les r√©seaux Docker ?
[%step]
* Dans Docker, chaque conteneur a son propre espace de nom r√©seau, ce qui signifie que localhost √† l'int√©rieur d'un conteneur fait r√©f√©rence au conteneur lui-m√™me, et non √† la machine h√¥te ou √† d'autres conteneurs.
* Lorsque vous essayez de faire un `ping` sur `gitlab-instance-gitlab-1` depuis le conteneur web, il ne conna√Æt pas le nom d'h√¥te `gitlab-instance-gitlab-1` car il n'est pas dans le m√™me espace de nom r√©seau.
* Pour permettre aux conteneurs de communiquer entre eux, ils doivent √™tre dans le m√™me r√©seau Docker.

[%auto-animate]
== üöÄ Comment configurer Dependabot pour GitLab ? ü¶äüõ†Ô∏è

* Lorsque vous utilisez Docker Compose, il cr√©e automatiquement un r√©seau par d√©faut pour votre application et tout service d√©fini dans le `docker-compose.yml` peut atteindre les autres en utilisant le nom du service comme nom d'h√¥te.

[%step]
* Dans notre cas, le conteneur `web` et le conteneur `gitlab-instance-gitlab-1` ne sont pas dans le m√™me r√©seau Docker.
* Vous pouvez v√©rifier cela en inspectant les r√©seaux de chaque conteneur √† l'aide de la commande `docker inspect`.
* S'ils ne sont pas dans le m√™me r√©seau, nous pouvons cr√©er un r√©seau et ajouter les deux services √† celui-ci dans notre fichier `docker-compose.yml`.

[%auto-animate]
== üöÄ Comment configurer Dependabot pour GitLab ? ü¶äüõ†Ô∏è

* Voici un exemple :
[%step]
[source,yaml]
----
version: '3'
services:
  web:
    image: web
    networks:
      - mynetwork
  gitlab-instance-gitlab-1:
    image: gitlab
    networks:
      - mynetwork
networks:
  mynetwork:
----
[%step]
* Apr√®s avoir mis √† jour votre fichier `docker-compose.yml`, vous devez recr√©er vos conteneurs pour que les modifications prennent effet.
* Vous pouvez le faire avec la commande `docker-compose up -d --force-recreate`.
* Apr√®s cela, vous devriez pouvoir faire un `ping` sur `gitlab-instance-gitlab-1` depuis le conteneur web.

[%auto-animate]
== üöÄ Comment configurer Dependabot pour GitLab ? ü¶äüõ†Ô∏è

[source,yaml]
----
include::../code-samples/bonus/dependabot/symbiosis/docker-compose-dependabot.yml[lines=135..137]
[...]
include::../code-samples/bonus/dependabot/symbiosis/docker-compose-dependabot.yml[lines=203..204]
----

[%step]
Et...

[%step]
[source,yaml]
----
include::../code-samples/bonus/dependabot/symbiosis/docker-compose-gitlab.yml[lines=5..9]
[...]
include::../code-samples/bonus/dependabot/symbiosis/docker-compose-gitlab.yml[lines=74..75]
----

[%auto-animate]
== üöÄ Comment configurer Dependabot pour GitLab ? ü¶äüõ†Ô∏è
Sauf que...
[%step]
[source,bash]
----
root@95def7cb933d:/home/dependabot/app# nmap -sn 172.30.0.0/16
Starting Nmap 7.80 ( https://nmap.org ) at 2023-11-21 20:45 UTC
Nmap scan report for 172.30.0.1
Host is up (0.0000090s latency).
MAC Address: 02:42:50:A6:7C:5A (Unknown)
Nmap scan report for symbiosis-gitlab-1.symbiosis_mynetwork (172.30.0.2)
Host is up (0.000012s latency).
MAC Address: 02:42:AC:1E:00:02 (Unknown)
Nmap scan report for symbiosis-gitlab-runner-1-1.symbiosis_mynetwork (172.30.0.3)
Host is up (0.000015s latency).
MAC Address: 02:42:AC:1E:00:03 (Unknown)
Nmap scan report for symbiosis-gitlab-runner-2-1.symbiosis_mynetwork (172.30.0.4)
Host is up (0.000032s latency).
MAC Address: 02:42:AC:1E:00:04 (Unknown)
Nmap scan report for symbiosis-redis-1.symbiosis_mynetwork (172.30.0.5)
Host is up (0.0000070s latency).
MAC Address: 02:42:AC:1E:00:05 (Unknown)
Nmap scan report for symbiosis-mongodb-1.symbiosis_mynetwork (172.30.0.6)
Host is up (0.000016s latency).
MAC Address: 02:42:AC:1E:00:06 (Unknown)
Nmap scan report for symbiosis-docker-1.symbiosis_mynetwork (172.30.0.7)
Host is up (0.000021s latency).
MAC Address: 02:42:AC:1E:00:07 (Unknown)
Nmap scan report for symbiosis-worker-1.symbiosis_mynetwork (172.30.0.9)
Host is up (0.000024s latency).
MAC Address: 02:42:AC:1E:00:09 (Unknown)
Nmap scan report for 95def7cb933d (172.30.0.10)
Host is up.
----

[%auto-animate]
== üöÄ Comment configurer Dependabot pour GitLab ? ü¶äüõ†Ô∏è
Victoire?

[%step]

[source,bash]
----
docker compose -f docker-compose-dependabot.yml exec -it -u root web b
ash
root@95def7cb933d:/home/dependabot/app# ping symbiosis-gitlab-1.symbiosis_mynetwork
PING symbiosis-gitlab-1.symbiosis_mynetwork (172.30.0.2) 56(84) bytes of data.
64 bytes from symbiosis-gitlab-1.symbiosis_mynetwork (172.30.0.2): icmp_seq=1 ttl=64 time=0.165 ms
64 bytes from symbiosis-gitlab-1.symbiosis_mynetwork (172.30.0.2): icmp_seq=2 ttl=64 time=0.053 ms
64 bytes from symbiosis-gitlab-1.symbiosis_mynetwork (172.30.0.2): icmp_seq=3 ttl=64 time=0.039 ms
64 bytes from symbiosis-gitlab-1.symbiosis_mynetwork (172.30.0.2): icmp_seq=4 ttl=64 time=0.040 ms
64 bytes from symbiosis-gitlab-1.symbiosis_mynetwork (172.30.0.2): icmp_seq=5 ttl=64 time=0.056 ms
^C
--- symbiosis-gitlab-1.symbiosis_mynetwork ping statistics ---
5 packets transmitted, 5 received, 0% packet loss, time 4165ms
rtt min/avg/max/mdev = 0.039/0.070/0.165/0.047 ms
----

[%step]
image::dependabot-404-gitlab.png[]

[%step]
On y est presque!

[.notes]
--

dependabot gitlab
updatecli
renovabot gitlab

gitlab complet docker compose
jenkins complet docker compose
Kube?

services ashutosh mix and match de conteneurs

build arm64, cloud et buildx
--

== Debugging : docker exec

rappel : `docker container exec `permet de lancer une commande dans un container

[source,bash]
----
docker exec <containerID> echo "hello"
----


[source,bash]
----
docker exec ‚Äìit <containerID> bash
----

== Debugging : docker inspect

rappel : `docker inspect `permet de lister toutes les caract√©ristiques d'une image ou d'un container.

On peut filtrer le retour de la commande avec `jq` ou l'option `--format`.


== Debugging : docker cp

Cette commande permet d'√©changer des fichiers entre un conteneur et la machine h√¥te.

[source,bash]
----
docker cp --help
Usage:  docker cp [OPTIONS] CONTAINER:SRC_PATH DEST_PATH|-
        docker cp [OPTIONS] SRC_PATH|- CONTAINER:DEST_PATH
Copy files/folders between a container and the local filesystem
Options:
  -a, --archive       Archive mode (copy all uid/gid information)
  -L, --follow-link   Always follow symbol link in SRC_PATH
----

== Debugging : docker history

Cette commande permet d'afficher la concat√©nation de tous les Dockerfiles qui ont abouti √† cette image.

[source,bash]
----
docker history nginx
IMAGE               CREATED             CREATED BY                                      SIZE                f35646e83998        4 weeks ago         /bin/sh -c #(nop)  CMD ["nginx" "-g" "daemon‚Ä¶   0B
<missing>           4 weeks ago         /bin/sh -c #(nop)  STOPSIGNAL SIGTERM           0B
<missing>           4 weeks ago         /bin/sh -c #(nop)  EXPOSE 80                    0B
<missing>           4 weeks ago         /bin/sh -c #(nop)  ENTRYPOINT ["/docker-entr‚Ä¶   0B
<missing>           4 weeks ago         /bin/sh -c #(nop) COPY file:0fd5fca330dcd6a7‚Ä¶   1.04kB
<missing>           4 weeks ago         /bin/sh -c #(nop) COPY file:1d0a4127e78a26c1‚Ä¶   1.96kB
<missing>           4 weeks ago         /bin/sh -c #(nop) COPY file:e7e183879c35719c‚Ä¶   1.2kB
<missing>           4 weeks ago         /bin/sh -c set -x     && addgroup --system -‚Ä¶   63.6MB
<missing>           4 weeks ago         /bin/sh -c #(nop)  ENV PKG_RELEASE=1~buster     0B
<missing>           4 weeks ago         /bin/sh -c #(nop)  ENV NJS_VERSION=0.4.4        0B
<missing>           4 weeks ago         /bin/sh -c #(nop)  ENV NGINX_VERSION=1.19.3     0B
<missing>           4 weeks ago         /bin/sh -c #(nop)  LABEL maintainer=NGINX Do‚Ä¶   0B
<missing>           4 weeks ago         /bin/sh -c #(nop)  CMD ["bash"]                 0B
<missing>           4 weeks ago         /bin/sh -c #(nop) ADD file:0dc53e7886c35bc21‚Ä¶   69.2MB
----

== Debugging : docker stats

Cette commande permet d'avoir les stats en temps r√©el d'un conteneur.

[source,bash]
----
docker stats 42f128
CONTAINER           CPU %     MEM USAGE/LIMIT     MEM %     NET I/O
42f128              0.00%     1.454 MB/4.145 GB   0.04%     648 B/648 B
----

== Travaux pratiques #14

Notre coll√®gue Michel d√©bute en Docker, il met √† disposition des images Docker pour notre entreprise.

Michel a eu la chance de gagner au Loto et il a quitt√© son bureau du jour au lendemain alors qu'il √©tait sur le point de nous d√©livrer une image Nginx.

Nous n'avons que le binaire de son image √† cette adresse.

https://owncloud.univ-artois.fr/index.php/s/9s8XBLXvRwBJsrm

On sait que `docker load `est la solution pour commencer

A l'aide !

== üê≥üò¥ Lazy Docker

https://blog.stephane-robert.info/docs/conteneurs/moteurs-conteneurs/lazydocker/

[%auto-animate]
[.columns]
== Conseils pour l'eval'
[.column]
--
image::final answer.png[height=500px]
--
[.column]
--
* https://moodle.univ-artois.fr/mod/resource/view.php?id=39414
* https://moodle.univ-artois.fr/mod/choicegroup/view.php?id=39415
* https://moodle.univ-artois.fr/mod/assign/view.php?id=39416
--

[%auto-animate]
== Conseils pour l'eval'

image::dont panic.png[height=500px]

== Vous devez avoir les comp√©tences suivantes:

Savoir lancer un container avec toutes les options

* `-v, -p, -w, -e, --rm, etc.`

√âcrire un Dockerfile optimis√© pour "dockeriser" une application

* pas trop gourmand, facile √† modifier, param√©trable.

√âtudier une image ou un conteneur pour tout d√©bug √©ventuel.

Savoir s'outiller pour avoir des images qui servent d'environnement d'ex√©cution √† votre CI.

Monter un √©cosyst√®me applicatif complexe via docker-compose.

== Que revoir ?

Les TPs sont vos meilleurs amis.

La documentation officielle de Docker

https://docs.docker.com/engine/reference/run/

https://docs.docker.com/engine/reference/builder/

https://docs.docker.com/develop/develop-images/dockerfile_best-practices/

== ü§îüëâ One more thing

image::415439355-image7.png[height=500px]
