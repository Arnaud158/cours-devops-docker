= Bonus


== Les petits plus

image::902050214-image2.png[]
image::902050214-image2.png[]
image::902050214-image2.png[]
image::902050214-image2.png[]
image::902050214-image2.png[]
image::902050214-image2.png[]

[%auto-animate]
== "Il en remet une couche"

[source,bash]
----
docker history nginx
IMAGE               CREATED             CREATED BY                                      SIZE                COMMENT
f35646e83998        4 weeks ago         /bin/sh -c #(nop)  CMD ["nginx" "-g" "daemon‚Ä¶   0B
<missing>           4 weeks ago         /bin/sh -c #(nop)  STOPSIGNAL SIGTERM           0B
<missing>           4 weeks ago         /bin/sh -c #(nop)  EXPOSE 80                    0B
<missing>           4 weeks ago         /bin/sh -c #(nop)  ENTRYPOINT ["/docker-entr‚Ä¶   0B
<missing>           4 weeks ago         /bin/sh -c #(nop) COPY file:0fd5fca330dcd6a7‚Ä¶   1.04kB
<missing>           4 weeks ago         /bin/sh -c #(nop) COPY file:1d0a4127e78a26c1‚Ä¶   1.96kB
<missing>           4 weeks ago         /bin/sh -c #(nop) COPY file:e7e183879c35719c‚Ä¶   1.2kB
<missing>           4 weeks ago         /bin/sh -c set -x     && addgroup --system -‚Ä¶   63.6MB
<missing>           4 weeks ago         /bin/sh -c #(nop)  ENV PKG_RELEASE=1~buster     0B
<missing>           4 weeks ago         /bin/sh -c #(nop)  ENV NJS_VERSION=0.4.4        0B
<missing>           4 weeks ago         /bin/sh -c #(nop)  ENV NGINX_VERSION=1.19.3     0B
<missing>           4 weeks ago         /bin/sh -c #(nop)  LABEL maintainer=NGINX Do‚Ä¶   0B
<missing>           4 weeks ago         /bin/sh -c #(nop)  CMD ["bash"]                 0B
<missing>           4 weeks ago         /bin/sh -c #(nop) ADD file:0dc53e7886c35bc21‚Ä¶   69.2MB
----

[%auto-animate]
== "Il en remet une couche"

[source,bash]
----
docker history nginx
IMAGE               CREATED             CREATED BY                                      SIZE                COMMENT
f35646e83998        4 weeks ago         /bin/sh -c #(nop)  CMD ["nginx" "-g" "daemon‚Ä¶   0B
<missing>           4 weeks ago         /bin/sh -c #(nop)  STOPSIGNAL SIGTERM           0B
<missing>           4 weeks ago         /bin/sh -c #(nop)  EXPOSE 80                    0B
<missing>           4 weeks ago         /bin/sh -c #(nop)  ENTRYPOINT ["/docker-entr‚Ä¶   0B
<missing>           4 weeks ago         /bin/sh -c #(nop) COPY file:0fd5fca330dcd6a7‚Ä¶   1.04kB
<missing>           4 weeks ago         /bin/sh -c #(nop) COPY file:1d0a4127e78a26c1‚Ä¶   1.96kB
<missing>           4 weeks ago         /bin/sh -c #(nop) COPY file:e7e183879c35719c‚Ä¶   1.2kB
<missing>           4 weeks ago         /bin/sh -c set -x     && addgroup --system -‚Ä¶   63.6MB
<missing>           4 weeks ago         /bin/sh -c #(nop)  ENV PKG_RELEASE=1~buster     0B
<missing>           4 weeks ago         /bin/sh -c #(nop)  ENV NJS_VERSION=0.4.4        0B
<missing>           4 weeks ago         /bin/sh -c #(nop)  ENV NGINX_VERSION=1.19.3     0B
<missing>           4 weeks ago         /bin/sh -c #(nop)  LABEL maintainer=NGINX Do‚Ä¶   0B
<missing>           4 weeks ago         /bin/sh -c #(nop)  CMD ["bash"]                 0B
<missing>           4 weeks ago         /bin/sh -c #(nop) ADD file:0dc53e7886c35bc21‚Ä¶   69.2MB
----

Il est pr√©f√©rable de limiter le nombre de couches pour limiter la bande passante.

[%auto-animate]
== "Il en remet une couche"

[source,bash]
----
RUN apk add \
     patch \
     tar \
     mercurial \
     git \
     ruby \
     ruby-devel \
     rubygem-bundler \
     make \
     gcc-c++ \
     zlib-devel \
     libxml2-devel \
     docker \
     nodejs \
     npm \
     sssd \
 && mkdir -p /var/lib/docker-builder \
 && mkdir -p /etc/docker-builder
----

== Ne pas charger inutilement !

[source,bash]
----
 && apk remove make gcc maven ... \
 && rm -f previously-downloaded.tar.gz \
 && apk clean all \
 && rm -rf /tmp/*
----
[%step]
Il est utile, pour des raisons d'espace, de nettoyer le filesystem de ses futurs containers, en donnant les bonnes instructions dans le Dockerfile.

== Documentez !

Les mots cl√©s `EXPOSE` et `LABEL` peuvent fournir de pr√©cieuses informations aux utilisateurs de vos images !

(les ports expos√©s par d√©faut, les auteurs de l'image, la version d'un middleware embarqu√©, ‚Ä¶)

== Pr√©parez-vous au read-only

Il est possible de lister toutes les modifications qui ont √©t√© apport√©es au filesystem d'un container.

[source,bash]
----
docker diff 29f1c4
C /run
A /run/nginx.pid
C /var
C /var/lib
C /var/lib/nginx
C /var/lib/nginx/tmp
A /var/lib/nginx/tmp/client_body
A /var/lib/nginx/tmp/fastcgi
A /var/lib/nginx/tmp/proxy
A /var/lib/nginx/tmp/scgi
A /var/lib/nginx/tmp/uwsgi
C /var/log
C /var/log/nginx
A /var/log/nginx/access.log
A /var/log/nginx/error.log
----
[%step]
Une bonne piste pour savoir quels volumes d√©clarer !

== HealthCheck

Savoir que mon PID 1 est toujours en cours d'ex√©cution n'est peut-√™tre pas la meilleure piste pour savoir si mon conteneur est en bonne sant√© !

[source,bash]
----
FROM ghost:3
RUN apt update && apt install curl -y \
        && rm -rf /var/lib/apt/lists/*

HEALTHCHECK --interval=1m --timeout=30s --retries=3 CMD curl --fail http://localhost:2368 || exit 1
----

source : https://www.grottedubarbu.fr/docker-healthcheck/

== Debugging

image::1939424428-image3.gif[]

== Une tonne d'outils !

Les logs

* des containers

* du d√©mon Docker

[source,bash]
----
docker container exec
docker inspect
docker cp
docker history
docker stats
----

== Debugging : Les logs

rappel : `docker container logs` permet de lister les logs des conteneurs.

[%step]
[source,bash]
----
docker container logs 47d6
Fri Nov 20 00:39:52 UTC 2023
Fri Nov 20 00:39:53 UTC 2023
----

== Concentrateur de logs

Par d√©faut, les logs des conteneurs sont stock√©s dans des fichiers json. Mais comment faire pour les envoyer vers un concentrateur ?

[%step]
----
docker container run -d
--log-driver=gelf
--log-opt gelf-address=udp://localhost:12201
-p 88:80
nginx
----
[%step]
on sp√©cifie un driver
[%step]
on configure le driver

== Travaux pratiques #13

√âtapes

Lancer une stack ELK gr√¢ce aux fichiers fournis dans le repo https://gitlab.univ-artois.fr/bruno.verachten/devops-docker-tp13

Alimenter en logs avec la commande `docker container run --log-driver=gelf --log-opt gelf-address=udp://localhost:12201 alpine bash -c 'seq 1 100'`

Cr√©er un index "timestamp" sur Kibana puis aller √† l'√©cran "discover"

Lancer un conteneur nginx et concentrez ses logs dans ELK

[.columns]
== GitLab et Dependabot

[.column]
image::https://about.gitlab.com/images/press/press-kit-icon.svg[height=200px]
[.column]
image::https://avatars.githubusercontent.com/u/27347476?s=200&v=4[height=200px]

== ü§î Qu'est-ce que Dependabot ?

Dependabot est un outil qui vous aide √† maintenir vos d√©pendances √† jour.

image::https://avatars.githubusercontent.com/u/27347476?s=200&v=4[]

[%step]
Il ouvre automatiquement des merge requests pour les mises √† jour de d√©pendances dans vos projets GitLab.

== üõ†Ô∏è Comment Dependabot fonctionne-t-il avec Docker ?

Dependabot peut analyser vos `Dockerfiles` et vos fichiers `docker-compose` pour trouver les d√©pendances qui peuvent √™tre mises √† jour.
[%step]
Il cr√©e ensuite des merge requests pour chaque mise √† jour de d√©pendance.

== üéØ Pourquoi utiliser Dependabot avec Docker ?

. Garder vos d√©pendances √† jour est crucial pour la s√©curit√© et la stabilit√© de vos applications.
. Dependabot automatise ce processus, vous faisant gagner du temps et r√©duisant le risque d'oublier une mise √† jour importante.
. Dependabot n'est pas magique, il faut que votre CI soit capable de construire votre application avec les nouvelles d√©pendances.
. Ce qui n'est pas test√© ne fonctionne pas.

[%auto-animate]
== üöÄ Comment configurer Dependabot pour GitLab ? ü¶äüõ†Ô∏è

* Malheureusement, il n'y a pas encore de support officiel pour GitLab dans Dependabot (et vice versa).
[%step]
* Notre forge Gitlab est d√©finie dans un fichier docker-compose.yml, et Dependabot aussi.
* Dependabot doit avoir acc√®s √† notre forge GitLab pour pouvoir ouvrir des merge requests.
* Suivons donc https://dependabot-gitlab.gitlab.io/dependabot/guide/getting-started.html#step-2-set-up-access-tokens[la documentation officielle].

[%auto-animate]
== !

image::personal-access-token.png[background, size=cover]

[%auto-animate]
== !

image::personal-access-token-settings.png[background, size=cover]

[%auto-animate]
== üöÄ Comment configurer Dependabot pour GitLab ? ü¶äüõ†Ô∏è

WARNING: Notez bien le token, vous ne le reverrez plus jamais.

https://dependabot-gitlab.gitlab.io/dependabot/guide/getting-started.html#step-3-start-the-app[L'√©tape suivante], c'est de positionner les valeurs de certaines variables d'environnement.
√áa peut √™tre dans un `.env`, ou dans les variables d'environnement de votre machine.
[source,bash]
----
export SETTINGS__GITLAB_URL=http://localhost
export SETTINGS__GITLAB_ACCESS_TOKEN=glpat-LXUfrxeFXuRJXNTNNifD
----

[%auto-animate]
== üöÄ Comment configurer Dependabot pour GitLab ? ü¶äüõ†Ô∏è

D√©marrez l'application avec `docker compose`:

[source,bash]
----
curl -s https://gitlab.com/dependabot-gitlab/dependabot/-/raw/v3.8.0-alpha.1/docker-compose.yml | docker compose -f - up -d
----
[%step]
image::dependabot-cant-see-gitlab.png[]
[%step]
üò¢

[%auto-animate]
== üöÄ Comment configurer Dependabot pour GitLab ? ü¶äüõ†Ô∏è

Vous vous souvenez du chapitre sur les r√©seaux Docker ?
[%step]
* Dans Docker, chaque conteneur a son propre espace de nom r√©seau, ce qui signifie que localhost √† l'int√©rieur d'un conteneur fait r√©f√©rence au conteneur lui-m√™me, et non √† la machine h√¥te ou √† d'autres conteneurs.
* Lorsque vous essayez de faire un `ping` sur `gitlab-instance-gitlab-1` depuis le conteneur web, il ne conna√Æt pas le nom d'h√¥te `gitlab-instance-gitlab-1` car il n'est pas dans le m√™me espace de nom r√©seau.
* Pour permettre aux conteneurs de communiquer entre eux, ils doivent √™tre dans le m√™me r√©seau Docker.

[%auto-animate]
== üöÄ Comment configurer Dependabot pour GitLab ? ü¶äüõ†Ô∏è

* Lorsque vous utilisez Docker Compose, il cr√©e automatiquement un r√©seau par d√©faut pour votre application et tout service d√©fini dans le `docker-compose.yml` peut atteindre les autres en utilisant le nom du service comme nom d'h√¥te.

[%step]
* Dans notre cas, le conteneur `web` et le conteneur `gitlab-instance-gitlab-1` ne sont pas dans le m√™me r√©seau Docker.
* Vous pouvez v√©rifier cela en inspectant les r√©seaux de chaque conteneur √† l'aide de la commande `docker inspect`.
* S'ils ne sont pas dans le m√™me r√©seau, nous pouvons cr√©er un r√©seau et ajouter les deux services √† celui-ci dans notre fichier `docker-compose.yml`.

[%auto-animate]
== üöÄ Comment configurer Dependabot pour GitLab ? ü¶äüõ†Ô∏è

* Voici un exemple :
[%step]
[source,yaml]
----
version: '3'
services:
  web:
    image: web
    networks:
      - mynetwork
  gitlab-instance-gitlab-1:
    image: gitlab
    networks:
      - mynetwork
networks:
  mynetwork:
----
[%step]
* Apr√®s avoir mis √† jour votre fichier `docker-compose.yml`, vous devez recr√©er vos conteneurs pour que les modifications prennent effet.
* Vous pouvez le faire avec la commande `docker compose up -d --force-recreate`.
* Apr√®s cela, vous devriez pouvoir faire un `ping` sur `gitlab-instance-gitlab-1` depuis le conteneur web.

[%auto-animate]
== üöÄ Comment configurer Dependabot pour GitLab ? ü¶äüõ†Ô∏è

[source,yaml]
----
include::../code-samples/bonus/dependabot/symbiosis/docker-compose-dependabot.yml[lines=135..137]
[...]
include::../code-samples/bonus/dependabot/symbiosis/docker-compose-dependabot.yml[lines=203..204]
----

[%step]
Et...

[%step]
[source,yaml]
----
include::../code-samples/bonus/dependabot/symbiosis/docker-compose-gitlab.yml[lines=5..9]
[...]
include::../code-samples/bonus/dependabot/symbiosis/docker-compose-gitlab.yml[lines=74..75]
----

[%auto-animate]
== üöÄ Comment configurer Dependabot pour GitLab ? ü¶äüõ†Ô∏è
Sauf que...
[%step]
[source,bash]
----
root@95def7cb933d:/home/dependabot/app# nmap -sn 172.30.0.0/16
Starting Nmap 7.80 ( https://nmap.org ) at 2023-11-21 20:45 UTC
Nmap scan report for 172.30.0.1
Host is up (0.0000090s latency).
MAC Address: 02:42:50:A6:7C:5A (Unknown)
Nmap scan report for symbiosis-gitlab-1.symbiosis_mynetwork (172.30.0.2)
Host is up (0.000012s latency).
MAC Address: 02:42:AC:1E:00:02 (Unknown)
Nmap scan report for symbiosis-gitlab-runner-1-1.symbiosis_mynetwork (172.30.0.3)
Host is up (0.000015s latency).
MAC Address: 02:42:AC:1E:00:03 (Unknown)
Nmap scan report for symbiosis-gitlab-runner-2-1.symbiosis_mynetwork (172.30.0.4)
Host is up (0.000032s latency).
MAC Address: 02:42:AC:1E:00:04 (Unknown)
Nmap scan report for symbiosis-redis-1.symbiosis_mynetwork (172.30.0.5)
Host is up (0.0000070s latency).
MAC Address: 02:42:AC:1E:00:05 (Unknown)
Nmap scan report for symbiosis-mongodb-1.symbiosis_mynetwork (172.30.0.6)
Host is up (0.000016s latency).
MAC Address: 02:42:AC:1E:00:06 (Unknown)
Nmap scan report for symbiosis-docker-1.symbiosis_mynetwork (172.30.0.7)
Host is up (0.000021s latency).
MAC Address: 02:42:AC:1E:00:07 (Unknown)
Nmap scan report for symbiosis-worker-1.symbiosis_mynetwork (172.30.0.9)
Host is up (0.000024s latency).
MAC Address: 02:42:AC:1E:00:09 (Unknown)
Nmap scan report for 95def7cb933d (172.30.0.10)
Host is up.
----

[%auto-animate]
== üöÄ Comment configurer Dependabot pour GitLab ? ü¶äüõ†Ô∏è
Victoire?

[%step]

[source,bash]
----
docker compose -f docker-compose-dependabot.yml exec -it -u root web b
ash
root@95def7cb933d:/home/dependabot/app# ping symbiosis-gitlab-1.symbiosis_mynetwork
PING symbiosis-gitlab-1.symbiosis_mynetwork (172.30.0.2) 56(84) bytes of data.
64 bytes from symbiosis-gitlab-1.symbiosis_mynetwork (172.30.0.2): icmp_seq=1 ttl=64 time=0.165 ms
64 bytes from symbiosis-gitlab-1.symbiosis_mynetwork (172.30.0.2): icmp_seq=2 ttl=64 time=0.053 ms
64 bytes from symbiosis-gitlab-1.symbiosis_mynetwork (172.30.0.2): icmp_seq=3 ttl=64 time=0.039 ms
64 bytes from symbiosis-gitlab-1.symbiosis_mynetwork (172.30.0.2): icmp_seq=4 ttl=64 time=0.040 ms
64 bytes from symbiosis-gitlab-1.symbiosis_mynetwork (172.30.0.2): icmp_seq=5 ttl=64 time=0.056 ms
^C
--- symbiosis-gitlab-1.symbiosis_mynetwork ping statistics ---
5 packets transmitted, 5 received, 0% packet loss, time 4165ms
rtt min/avg/max/mdev = 0.039/0.070/0.165/0.047 ms
----

[%step]
image::dependabot-404-gitlab.png[]

[%step]
On y est presque!

[.notes]
--

dependabot gitlab
updatecli
renovabot gitlab

gitlab complet docker compose
jenkins complet docker compose
Kube?

services ashutosh mix and match de conteneurs

build arm64, cloud et buildx
--

== Debugging : docker exec

rappel : `docker container exec `permet de lancer une commande dans un container

[source,bash]
----
docker exec <containerID> echo "hello"
----


[source,bash]
----
docker exec ‚Äìit <containerID> bash
----

== Debugging : docker inspect

rappel : `docker inspect `permet de lister toutes les caract√©ristiques d'une image ou d'un container.

On peut filtrer le retour de la commande avec `jq` ou l'option `--format`.


== Debugging : docker cp

Cette commande permet d'√©changer des fichiers entre un conteneur et la machine h√¥te.

[source,bash]
----
docker cp --help
Usage:  docker cp [OPTIONS] CONTAINER:SRC_PATH DEST_PATH|-
        docker cp [OPTIONS] SRC_PATH|- CONTAINER:DEST_PATH
Copy files/folders between a container and the local filesystem
Options:
  -a, --archive       Archive mode (copy all uid/gid information)
  -L, --follow-link   Always follow symbol link in SRC_PATH
----

== Debugging : docker history

Cette commande permet d'afficher la concat√©nation de tous les Dockerfiles qui ont abouti √† cette image.

[source,bash]
----
docker history nginx
IMAGE               CREATED             CREATED BY                                      SIZE                f35646e83998        4 weeks ago         /bin/sh -c #(nop)  CMD ["nginx" "-g" "daemon‚Ä¶   0B
<missing>           4 weeks ago         /bin/sh -c #(nop)  STOPSIGNAL SIGTERM           0B
<missing>           4 weeks ago         /bin/sh -c #(nop)  EXPOSE 80                    0B
<missing>           4 weeks ago         /bin/sh -c #(nop)  ENTRYPOINT ["/docker-entr‚Ä¶   0B
<missing>           4 weeks ago         /bin/sh -c #(nop) COPY file:0fd5fca330dcd6a7‚Ä¶   1.04kB
<missing>           4 weeks ago         /bin/sh -c #(nop) COPY file:1d0a4127e78a26c1‚Ä¶   1.96kB
<missing>           4 weeks ago         /bin/sh -c #(nop) COPY file:e7e183879c35719c‚Ä¶   1.2kB
<missing>           4 weeks ago         /bin/sh -c set -x     && addgroup --system -‚Ä¶   63.6MB
<missing>           4 weeks ago         /bin/sh -c #(nop)  ENV PKG_RELEASE=1~buster     0B
<missing>           4 weeks ago         /bin/sh -c #(nop)  ENV NJS_VERSION=0.4.4        0B
<missing>           4 weeks ago         /bin/sh -c #(nop)  ENV NGINX_VERSION=1.19.3     0B
<missing>           4 weeks ago         /bin/sh -c #(nop)  LABEL maintainer=NGINX Do‚Ä¶   0B
<missing>           4 weeks ago         /bin/sh -c #(nop)  CMD ["bash"]                 0B
<missing>           4 weeks ago         /bin/sh -c #(nop) ADD file:0dc53e7886c35bc21‚Ä¶   69.2MB
----

== Debugging : docker stats

Cette commande permet d'avoir les stats en temps r√©el d'un conteneur.

[source,bash]
----
docker stats 42f128
CONTAINER           CPU %     MEM USAGE/LIMIT     MEM %     NET I/O
42f128              0.00%     1.454 MB/4.145 GB   0.04%     648 B/648 B
----

== üéì Travaux pratiques #14

Notre valeureux coll√®gue Jean-Michel s'initiait √† l'art myst√©rieux de Docker, et g√©n√©reusement partageait ses cr√©ations sous forme d'images Docker pour l'entreprise.

Michel a soudainement d√©croch√© le jackpot du Loto, laissant derri√®re lui son bureau du jour au lendemain, alors qu'il √©tait sur le point de nous offrir une image Nginx.

D√©sormais, nous n'avons que le binaire de son chef-d'≈ìuvre, accessible √† cette adresse :

https://owncloud.univ-artois.fr/index.php/s/9s8XBLXvRwBJsrm

Rassurez-vous, on nous a dit que `docker load` est la premi√®re √©tape de la formule magique pour percer les secrets de son ≈ìuvre.

√Ä vos claviers ! üßô‚Äç‚ôÇÔ∏è‚ú®

[%auto-animate]
== ‚úÖ Solution travaux pratiques #14üïµÔ∏è‚Äç‚ôÇÔ∏èüîç

`docker load` est la premi√®re √©tape de la formule magique
[%step]
Okay...
[%step]
üßô‚Äç‚ôÇÔ∏è‚ú®
[%step]
[source,bash]
----
docker load -i bad-nginx.dkr
Loaded image: bad-nginx:1
----
[%step]
Nous voil√† bien avanc√©s...
[%step]
On essaye de lancer un conteneur bas√© dessus‚ÄØ?
[%step]
[source,bash]
----
docker container run -d --name bad-1 bad-nginx:1
f4caa4a641729c0ab3d7b5974fa735c128047f75292c7f16495b72c7c6808502
----
[%step]
C'est lanc√©‚ÄØ?

[%auto-animate]
== ‚úÖ Solution travaux pratiques #14üïµÔ∏è‚Äç‚ôÇÔ∏èüîç

[source,bash]
----
docker container ls --format '{{.Names}}' | grep "bad"
----
[%step]
Oups, il n'est pas l√†...
[%step]
Essayons encore.
[%step]
[source,bash]
----
docker container ls -a --format '{{.Names}}' | grep "bad"
bad-1
----
[%step]
C'est donc lanc√©, mais il a crash√©.
[%step]
Allons donc chercher les logs...
[%step]
[source,bash]
----
docker container logs bad-1
Error : nginx is not executable
----
[%step]
On a trouv√© le probl√®me‚ÄØ!
[%step]
Spoiler alert¬†: on a trouv√© UN probl√®me, pas LE probl√®me.

[%auto-animate]
== ‚úÖ Solution travaux pratiques #14üïµÔ∏è‚Äç‚ôÇÔ∏èüîç
Je ne sais pas ce qu'a fait Jean-Michel, mais il a cass√© le binaire de Nginx.
[%step]
Est-ce un probl√®me de permission, de d√©pendance, de version, de compilation‚ÄØ?
[%step]
En tous cas, c'est cass√©.
[%step]
Regardons un peu ce que nous dit docker inspect de tout √ßa...
[%step]
[source,json]
----
docker image inspect bad-nginx:1
[
    {
        "Id": "sha256:a469e4d1cb0c61324298fc6fde09f78f211420a1848b690dec35d9ac324a6cab",
        "RepoTags": [
            "bad-nginx:1"
        ],
        [...]
        "ContainerConfig": {
            [...]
            "ExposedPorts": {
                "80/tcp": {}
            },
----
[%step]
Port 80 expos√©, c'est bon signe.

[%auto-animate]
== ‚úÖ Solution travaux pratiques #14üïµÔ∏è‚Äç‚ôÇÔ∏èüîç

[source,json]
----
            [...]
            "Env": [
                "PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
            ],
----
[%step]
On a un PATH, c'est bon signe.
[%step]
[source,json]
----
            "Cmd": [
                "/bin/sh",
                "-c",
                "#(nop) ",
                "CMD [\"/bin/sh\" \"-c\" \"nginx\"]"
            ],
----
[%step]
On a un CMD, c'est bon signe.

[%auto-animate]
== ‚úÖ Solution travaux pratiques #14üïµÔ∏è‚Äç‚ôÇÔ∏èüîç
[source,json]
----
            [...]
            "Entrypoint": [
                "/bin/sh",
                "-c",
                "/tmp/entrypoint.sh"
            ],
----
[%step]
On a un Entrypoint, c'est bon signe.

[%step]
[source,json]
----
            [...]
            "Labels": {
                [...]
                "org.label-schema.name": "CentOS Base Image",
                [...]
            }
        },
        "DockerVersion": "18.09.0",
        [...]
        "Architecture": "amd64",
        "Os": "linux",
        [...]
    }
]
----

[%auto-animate]
== ‚úÖ Solution travaux pratiques #14üïµÔ∏è‚Äç‚ôÇÔ∏èüîç
[source,json]
----
            [...]
            "Labels": {
                [...]
                "org.label-schema.name": "CentOS Base Image",
                [...]
            }
        },
        "DockerVersion": "18.09.0",
        [...]
        "Architecture": "amd64",
        "Os": "linux",
        [...]
    }
]
----
[%step]
C'est bien une image Linux `amd64` (donc pour ton PC, mais pas pour ton Mac M1, toi l√†-bas), mais argh, c'est bas√© sur CentOS, pas sur Alpine ou Debian‚ÄØ!
[%step]
√áa a √©t√© construit avec une vieille version de Docker.
[%step]
Qu'est-ce qu'on fait maintenant‚ÄØ?

[%auto-animate]
[.columns]
== ‚úÖ Solution travaux pratiques #14üïµÔ∏è‚Äç‚ôÇÔ∏èüîç
[.column]
--
Tournons-nous vers l'histoire‚ÄØ!

image::https://img.20mn.fr/JejnWnikSbSj5suCAo9pug/1200x768_stephane-bern-arrive-elysee-4-octobre-2017.jpg[]
--
[.column]
--
[%step]
[source,bash]
----
docker history bad-nginx:1
IMAGE          CREATED       CREATED BY                                      SIZE      COMMENT
a469e4d1cb0c   3 years ago   /bin/sh -c #(nop)  CMD ["/bin/sh" "-c" "ngin‚Ä¶   0B
<missing>      3 years ago   /bin/sh -c #(nop)  ENTRYPOINT ["/bin/sh" "-c‚Ä¶   0B
<missing>      3 years ago   /bin/sh -c #(nop)  EXPOSE 80                    0B
<missing>      3 years ago   /bin/sh -c #(nop) COPY file:b0fc89bcaf962602‚Ä¶   98B
<missing>      3 years ago   /bin/sh -c yum install -y nginx && yum clean‚Ä¶   56.7MB
<missing>      3 years ago   /bin/sh -c #(nop)  CMD ["/bin/bash"]            0B
<missing>      3 years ago   /bin/sh -c #(nop)  LABEL org.label-schema.sc‚Ä¶   0B
<missing>      3 years ago   /bin/sh -c #(nop) ADD file:538afc0c5c964ce0d‚Ä¶   215MB
----
[%step]
√áa se lit de bas en haut...
[%step]
Le premier `ADD` est l'image de base, CentOS.
[%step]
La deuxi√®me ligne, c'est une m√©tadata, on s'en fiche un peu.
[%step]
La troisi√®me ligne, c'est le `CMD` de l'image de base, qui est `bash`.
[%step]
La quatri√®me ligne, c'est l'installation de Nginx par l'inf√¢me `yum` de Centos (d√©j√† rep√©r√© dans le `docker inspect`).
--

[%auto-animate]
== ‚úÖ Solution travaux pratiques #14üïµÔ∏è‚Äç‚ôÇÔ∏èüîç

[source,bash]
----
docker history bad-nginx:1
IMAGE          CREATED       CREATED BY                                      SIZE      COMMENT
a469e4d1cb0c   3 years ago   /bin/sh -c #(nop)  CMD ["/bin/sh" "-c" "ngin‚Ä¶   0B
<missing>      3 years ago   /bin/sh -c #(nop)  ENTRYPOINT ["/bin/sh" "-c‚Ä¶   0B
<missing>      3 years ago   /bin/sh -c #(nop)  EXPOSE 80                    0B
<missing>      3 years ago   /bin/sh -c #(nop) COPY file:b0fc89bcaf962602‚Ä¶   98B
<missing>      3 years ago   /bin/sh -c yum install -y nginx && yum clean‚Ä¶   56.7MB
<missing>      3 years ago   /bin/sh -c #(nop)  CMD ["/bin/bash"]            0B
<missing>      3 years ago   /bin/sh -c #(nop)  LABEL org.label-schema.sc‚Ä¶   0B
<missing>      3 years ago   /bin/sh -c #(nop) ADD file:538afc0c5c964ce0d‚Ä¶   215MB
----
[%step]
La cinqui√®me ligne, c'est sans doute la copie du fichier `index.html`.
[%step]
La sixi√®me ligne, c'est l' `EXPOSE` de l'image finale, qui est `80` (d√©j√† rep√©r√© dans le `docker inspect`).
[%step]
La septi√®me ligne, c'est le `ENTRYPOINT` de l'image finale, qui est `/bin/sh -c /tmp/entrypoint.sh` (d√©j√† rep√©r√© dans le `docker inspect`).

[%auto-animate]
== ‚úÖ Solution travaux pratiques #14üïµÔ∏è‚Äç‚ôÇÔ∏èüîç
R√©sumons-nous... On a:
[%step]
* une image de base CentOS (√† remplacer par Alpine ou Debian)
* une installation de `nginx`.
* un port `80` expos√©
* un `ENTRYPOINT` qui lance un script `nginx`
* un fichier HTML, qu'on n'a pas encore r√©cup√©r√©
[%step]
√áa progresse... On peut donc cr√©er un premier üíÄ Dockerfile

[%auto-animate]
== ‚úÖ Solution travaux pratiques #14üïµÔ∏è‚Äç‚ôÇÔ∏èüîçüíÄ

[source,dockerfile]
----
# Utiliser Alpine ou Debian comme image de base
FROM alpine

# Mettre √† jour le syst√®me et installer nginx
RUN apk update && apk add nginx

# Exposer le port 80
EXPOSE 80

# Ajouter un fichier HTML (remplacer /chemin/vers/votre/fichier.html par le chemin r√©el vers votre fichier HTML)
ADD /chemin/vers/votre/fichier.html /usr/share/nginx/html

# D√©finir le point d'entr√©e pour lancer nginx
ENTRYPOINT ["nginx", "-g", "daemon off;"]
----
[%step]
Comment r√©cup√©rer ce fichu fichier HTML?

[%auto-animate]
[.columns]
== ‚úÖ Solution travaux pratiques #14üïµÔ∏è‚Äç‚ôÇÔ∏èüîç
[.column]
--
Essayons de lancer un conteneur bas√© sur notre image, et de r√©cup√©rer le fichier HTML.
[%step]
Le binaire `nginx` est non fonctionnel, essayons de lancer un conteneur avec un shell.
[%step]

[source,bash]
----
docker container run -it --name bad-2 --entrypoint=sh bad-nginx:1 sh
/usr/bin/sh: /usr/bin/sh: cannot execute binary file
----
--
[.column]
--
[%step]
image::https://media.tenor.com/3gzS4mCevVkAAAAC/francais-queendugif.gif[]
[%step]
WARNING: Jean-Micheeeeeeeeeeeeeeeeel, j'ai deux mots √† te dire! üò°
--

[%auto-animate]
== ‚úÖ Solution travaux pratiques #14üïµÔ∏è‚Äç‚ôÇÔ∏èüîç
Le conteneur qui tourne, on oublie, donc... Jean-Michel a laiss√© un terrain min√© derri√®re lui. üí£
[%step]
Mais on a d'autres armes en r√©serve... Le `docker container create` par exemple‚ÄØ!
[%step]
[source,bash]
----
docker container create --name temp_container bad-nginx:1
9149745197df413f7966181f6ca517b68713edd32ff7c35cea6e958d549a7553
----
[%step]
Utilisons maintenant docker cp pour r√©cup√©rer le fichier HTML.
[%step]
Quel est le r√©pertoire o√π nginx s'attend √† trouver ses fichiers HTML √† servir?
[%step]
`/usr/share/nginx/html`
[source,bash]
----
docker cp temp_container:/usr/share/nginx/html .
----
[%auto-animate]
== üê≥üò¥ Lazy Docker

https://blog.stephane-robert.info/docs/conteneurs/moteurs-conteneurs/lazydocker/

[%auto-animate]
[.columns]
== Conseils pour l'√©val'
[.column]
--
image::final answer.png[height=500px]
--
[.column]
--
* https://moodle.univ-artois.fr/mod/resource/view.php?id=39414
* https://moodle.univ-artois.fr/mod/choicegroup/view.php?id=39415
* https://moodle.univ-artois.fr/mod/assign/view.php?id=39416
--

[%auto-animate]
== Conseils pour l'eval'

image::dont panic.png[height=500px]

== Vous devez avoir les comp√©tences suivantes:

Savoir lancer un container avec toutes les options

* `-v, -p, -w, -e, --rm, etc.`

√âcrire un Dockerfile optimis√© pour "dockeriser" une application

* pas trop gourmand, facile √† modifier, param√©trable.

√âtudier une image ou un conteneur pour tout d√©bug √©ventuel.

Savoir s'outiller pour avoir des images qui servent d'environnement d'ex√©cution √† votre CI.

Monter un √©cosyst√®me applicatif complexe via docker-compose.

== Que revoir ?

Les TPs sont vos meilleurs amis.

La documentation officielle de Docker

https://docs.docker.com/engine/reference/run/

https://docs.docker.com/engine/reference/builder/

https://docs.docker.com/develop/develop-images/dockerfile_best-practices/

== ü§îüëâ One more thing

image::415439355-image7.png[height=500px]
